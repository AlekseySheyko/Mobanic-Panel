<!DOCTYPE html>
<html lang="en">
  <head>
  	<meta charset="utf-8">

	<title>Mobanic - Portal</title>
	<link rel="icon" type="image/png" href="img/favicon.png">	
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link href="css/jumbotron-narrow.css" rel="stylesheet">
  	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.2.min.js"></script>
  	<script type="text/javascript">
	    Parse.initialize("asQfJUeEXdJnbfvG2iefkvjhVpcmIq2GnOp5x5P2", "nekbtqyfm8m3K6DRekriIij1U3fnxPLGiAq01Nf7");

	    var currentUser = Parse.User.current();
		if (!currentUser) {
		    window.location.replace('index.html');
		}

		var carId = location.search.split('carId=')[1];

		var CarObject = Parse.Object.extend("Car");
		var query = new Parse.Query(CarObject);
		query.get(carId, {
		  success: function(carObject) {
		    
		    document.getElementById("inputMake").value = carObject.get('make');
		    document.getElementById("inputModel").value = carObject.get('model');
		    document.getElementById("inputYear").value = carObject.get('year');
		    document.getElementById("inputPrice").value = carObject.get('price');

		    document.getElementById("inputMileage").value = carObject.get('mileage');
		    document.getElementById("inputPreviousOwners").value = carObject.get('previousOwners');
		    var engine = carObject.get('engine');
		    engine = engine.substring(0, engine.length - 2);
		    document.getElementById("inputEngine").value = engine;
		    document.getElementById("inputTransmission").value = carObject.get('transmission');
		    document.getElementById("inputFuelType").value = carObject.get('fuelType');
		    document.getElementById("inputColor").value = carObject.get('color');
		    document.getElementById("inputLocation").value = carObject.get('location');

		  },
		  error: function(carObject, error) {
		    alert("Car not found");
		    window.location.replace('manage.html');
		  }
		});

  	</script>
  </head>

  <body>

  	<div class="container">
  		<div class="header clearfix">
        <nav>
          <ul class="nav nav-pills pull-right">
            <li role="presentation" class="active"><a href="index.html">Portal</a></li>
            <li role="presentation"><a href="http://mobanic.com">Home</a></li>
          </ul>
        </nav>
        <a href="http://mobanic.com"><img src="img/header_logo.png"</img></a>
      
      </div>

    <div class="jumbotron">
    	<form onsubmit="return saveCar();" enctype="multipart/form-data">
	    <h1 style="font-size: 40px">Edit car</h1><br>
		<div class="form-group">
		  <label for="inputMake label-large">Make</label>
		  <input type="text" class="form-control input-lg" id="inputMake" placeholder="Car make" autofocus>
		</div>
		<div class="form-group">
		  <label for="inputModel">Model</label>
		  <input type="text" class="form-control input-lg" id="inputModel" placeholder="Car model" required>
		</div>
		<div class="form-group">
		  <label for="inputYear">Year</label>
		  <input type="number" class="form-control input-lg" id="inputYear" placeholder="Model year" required>
		</div>
		<div class="form-group">
		  <label for="inputPrice">Price</label>
		  <input type="number" class="form-control input-lg" id="inputPrice" placeholder="Price, £" required>
		</div><br><br>

		<div class="form-group">
			<label for="inputMileage">Specs</label>
			<input type="number" class="form-control" id="inputMileage" placeholder="Mileage, km" style="border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
	        <input type="number" class="form-control" id="inputPreviousOwners" placeholder="Previous owners" style="border-radius: 0">
	        <input type="number" class="form-control" id="inputEngine" placeholder="Engine, cc" style="border-radius: 0">
	        <input class="form-control" id="inputTransmission" placeholder="Transmission type" style="border-radius: 0">
	        <input class="form-control" id="inputFuelType" placeholder="Fuel type" style="border-radius: 0">
	        <input class="form-control" id="inputColor" placeholder="Color" style="border-radius: 0">
	        <input class="form-control" id="inputLocation" placeholder="Location (country code)" style="border-top-left-radius: 0; border-top-right-radius: 0;">
        </div><br><br>

		<div class="form-group">
		  <label for="exampleInputFile">New cover image</label>
		  <input type="file" id="coverImg" accept="image/x-png, image/gif, image/jpeg">
		  <p class="help-block">Leave empty if you don't want to change one.</p>
		</div><br>
		<div class="form-group">
		  <label for="exampleInputFile">New gallery images</label>
		  <input type="file" id="galleryImgs" accept="image/x-png, image/gif, image/jpeg" multiple>
		  <p class="help-block">Additional images to show in detail view.</p>
		</div><br>
		<button type="submit" class="btn btn-lg btn-success">Save</button>
	  </form>
	</div><br><br><br>

	<footer class="footer">
      <p class="text-center">Copyright © 2015 Mobanic Ltd</p>
    </footer>
    </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
	<script type="text/javascript">

	 	function saveCar() {
			event.preventDefault();


			var carId = location.search.split('carId=')[1];

			var CarObject = Parse.Object.extend("Car");
			var query = new Parse.Query(CarObject);
			query.get(carId, {
			  success: function(carObject) {

					var make = document.getElementById("inputMake").value;
					var model = document.getElementById("inputModel").value;
					var year = parseInt(document.getElementById("inputYear").value);
					var price = parseInt(document.getElementById("inputPrice").value);
					var mileage = parseInt(document.getElementById("inputMileage").value);
					var previousOwners = parseInt(document.getElementById("inputPreviousOwners").value);
					var engine = parseInt(document.getElementById("inputEngine").value);
					var transmission = document.getElementById("inputTransmission").value;
					var fuelType = document.getElementById("inputFuelType").value;
					var color = document.getElementById("inputColor").value;
					var location = document.getElementById("inputLocation").value;

				    carObject.set("make", make);
				    carObject.set("model", model);
				    carObject.set("year", year);
				    carObject.set("price", price);
				    if (document.getElementById("inputMileage").value) {
				    	carObject.set("mileage", mileage);
				    }
				    if (document.getElementById("inputPreviousOwners").value) {
				    	carObject.set("previousOwners", previousOwners);
				    }
				    if (document.getElementById("inputEngine").value) {
				    	carObject.set("engine", engine + "cc");
				    }
				    if (transmission) {
				    	carObject.set("transmission", transmission);
				    }
				    if (fuelType) {
				    	carObject.set("fuelType", fuelType);
				    }
				    if (color) {
				    	carObject.set("color", color);
				    }
				    if (location) {
				    	carObject.set("location", location);
				    }


					var fileUploadControl = $("#coverImg")[0];
				    if (fileUploadControl.files.length > 0) {
					    var file = fileUploadControl.files[0];
					    var name = "coverImage.png";

					    var parseFile = new Parse.File(name, file);

					    parseFile.save();
				    	carObject.set("coverImage", parseFile);		
					}
						    

					fileUploadControl = $("#galleryImgs")[0];
					var relation = carObject.relation("galleryImage")
					for (var i = 0; i < fileUploadControl.files.length; i++) {
						var GalleryImage = Parse.Object.extend("GalleryImages");
				    	var galleryImage = new GalleryImage();

				    	var file = fileUploadControl.files[0];
					    var name = "galleryImage" + (i+1) + ".png";

					    parseFile = new Parse.File(name, file);
					    parseFile.save();

					    galleryImage.set("image", parseFile);
					    galleryImage.save(null, {
						  success: function(gameScore) {
					    	relation.add(galleryImage);
						  },
						  error: function(gameScore, error) {
						  }
						});
					}


					carObject.save(null, {
					  success: function(gameScore) {
					    alert('Successfully updated');
					    window.location.replace('manage.html');
					  },
					  error: function(gameScore, error) {
					    alert('Failed to update the info, cause: ' + error.message);
					  }
					});


				},
			  error: function(carObject, error) {
			    alert("Car not found");
			    window.location.replace('manage.html');
			  }
			});

		}
	</script>
  </body>
</html>