<!DOCTYPE html>
<html lang="en">
  <head>
  	<meta charset="utf-8">

	<title>Mobanic - Upload</title>
	<link rel="icon" type="image/png" href="img/favicon.png">	
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link href="css/jumbotron-narrow.css" rel="stylesheet">
  	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.2.min.js"></script>
  	<script type="text/javascript">
	    Parse.initialize("asQfJUeEXdJnbfvG2iefkvjhVpcmIq2GnOp5x5P2", "nekbtqyfm8m3K6DRekriIij1U3fnxPLGiAq01Nf7");

	    var currentUser = Parse.User.current();
		if (!currentUser) {
		    window.location.replace('manage.html');
		}
  	</script>
  </head>

  <body>
  	<div class="container">

  		<div class="header clearfix">
	        <nav>
	          <ul class="nav nav-pills pull-right">
	            <li role="presentation" class="active"><a href="index.html">Portal</a></li>
	            <li role="presentation"><a href="http://mobanic.com">Home</a></li>
	          </ul>
	        </nav>
	        <a href="http://mobanic.com"><img src="img/header_logo.png"</img></a>
    	</div>

	    <div class="jumbotron">

	    	<form id="foo" onsubmit="return saveCar(event);" enctype="multipart/form-data">
			    <h1 style="font-size: 40px">Upload new car</h1><br>
				<div class="form-group">
				  <label for="inputMake label-large">Make</label>
				  <input type="text" class="form-control input-lg" id="inputMake" placeholder="Car make" required autofocus>
				</div>
				<div class="form-group">
				  <label for="inputModel">Model</label>
				  <input type="text" class="form-control input-lg" id="inputModel" placeholder="Car model" required>
				</div>
				<div class="form-group">
				<div class="styled-select large">
				  <label for="inputYear">Year</label>
				  <select class="form-control input-lg" id="inputYear" required>
				        	<option value="" disabled selected>Model year</option>
				        	<option value="2015">2015</option>
				        	<option value="2014">2014</option>
				        	<option value="2013">2013</option>
				        	<option value="2012">2012</option>
				        	<option value="2011">2011</option>
				        	<option value="2010">2010</option>
				        	<option value="2009">2009</option>
				        	<option value="2008">2008</option>
				        	<option value="2007">2007</option>
				        	<option value="2006">2006</option>
				        	<option value="2005">2005</option>
				        	<option value="1999">Older</option>
				  </select>
				</div>
				</div>
				<div class="form-group">
				  <label for="inputPrice">Price</label>
				  <div class="input-group">
					  <span class="input-group-addon">£</span>
					  <input type="number" class="form-control input-lg" id="inputPrice" placeholder="Price" required>
				  </div>
				</div>

				<br><br>

				<div class="form-group">
					<label for="inputMileage">Specs</label>
					<input type="number" class="form-control" id="inputMileage" placeholder="Mileage, km" style="border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
			        <input type="number" class="form-control" id="inputPreviousOwners" placeholder="Previous owners" style="border-radius: 0">
			        <input type="number" class="form-control" id="inputEngine" placeholder="Engine, cc" style="border-radius: 0">
			        <div class="styled-select">			        
				        <select class="form-control" id="inputTransmission" style="border-radius: 0">
				        	<option value="" disabled selected>Transmission type</option>
				        	<option value="Manual">Manual</option>
				        	<option value="Semi-Automatic">Semi-Automatic</option>
				        	<option value="Automatic">Automatic</option>
				        </select>
			        </div>
			        <div class="styled-select">
				        <select class="form-control" id="inputFuelType" style="border-radius: 0">
				        	<option value="" disabled selected>Fuel type</option>
				        	<option value="Petrol">Petrol</option>
				        	<option value="Diesel">Diesel</option>
				        </select>
			        </div>
			        <div class="styled-select">
				        <select class="form-control" id="inputColor" style="border-radius: 0">
				        	<option value="" disabled selected>Color</option>
				        	<option value="Black">Black</option>
				        	<option value="Silver">Silver</option>
				        	<option value="White">White</option>
				        	<option value="Eed">Red</option>
				        	<option value="Green">Green</option>
				        	<option value="Blue">Blue</option>
				        	<option value="Yellow">Yellow</option>
				        	<option value="Brown">Brown</option>
				        	<option value="Other">Other</option>
				        </select>
			        </div>
			        <input class="form-control" id="inputLocation" placeholder="Location (country code)" style="border-top-left-radius: 0; border-top-right-radius: 0;">
		        </div>

		        <br><br>
				<div class="form-group">
					<label for="inputMileage">Features</label>
			        <div id="dynamicInput">
				        <input type="text" name="myInputs[]" class="form-control" placeholder="Feature #1" style="border-bottom-left-radius: 0; border-bottom-right-radius: 0;" name="p_id[]">
				    </div>
				    <input type="button" class="btn btn-default" style="padding: 1px 12px; font-size: 13px; line-height: 1.5; border-radius: 3px; border-top-left-radius: 0; border-top-right-radius: 0;" value="Add another feature" onClick="addInput('dynamicInput');">
				</div>

		        <br><br>
				<div class="form-group">
				  <label for="exampleInputFile">Cover image</label>
				  <input type="file" id="coverImg" accept="image/x-png, image/gif, image/jpeg" required>
				  <p class="help-block">Will be shown in main car listing.</p>
				</div><br>
				<div class="form-group">
				  <label for="exampleInputFile">Gallery images</label>
				  <input type="file" id="galleryImgs" accept="image/x-png, image/gif, image/jpeg" multiple>
				  <p class="help-block">Additional images to show in detail view.</p>
				</div><br>
				<button type="submit" class="btn btn-lg btn-success">Save</button>
		  </form>

		</div>

		<br><br><br>

		<footer class="footer">
	      <p class="text-center">Copyright © 2015 Mobanic Ltd</p>
	    </footer>
    </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
	<script type="text/javascript">

		var counter = 1;
		var limit = 10;
		function addInput(divName){

		     if (counter == limit)  {
		          alert("You have reached the limit of adding " + counter + " features");
		     }
		     else {
		          var newdiv = document.createElement('div');
		          newdiv.innerHTML = "<input type='text' class='form-control'  style='border-radius: 0' " + 
		          					 			"name='myInputs[]' placeholder='Feature #" + (counter + 1) + "'' name='p_id[]'>";
		          document.getElementById(divName).appendChild(newdiv);
		          counter++;
		     }
		}

		function sendPush() {
			Parse.Push.send({
						  where: new Parse.Query(Parse.Installation),
						  data: {
				          	alert: "Update car listing"
				          }
						});
		}

	 	function saveCar(event) {
			event.preventDefault();

			var make = document.getElementById("inputMake").value;
			var model = document.getElementById("inputModel").value;
			var year = parseInt(document.getElementById("inputYear").value);
			var price = parseInt(document.getElementById("inputPrice").value);
			var mileage = parseInt(document.getElementById("inputMileage").value);
			var previousOwners = parseInt(document.getElementById("inputPreviousOwners").value);
			var engine = parseInt(document.getElementById("inputEngine").value);
			var transmission = document.getElementById("inputTransmission").value;
			var fuelType = document.getElementById("inputFuelType").value;
			var color = document.getElementById("inputColor").value;
			var location = document.getElementById("inputLocation").value;

			var CarObject = Parse.Object.extend("Car");
		    var carObject = new CarObject();

		    carObject.set("make", make);
		    carObject.set("model", model);
		    carObject.set("year", year);
		    carObject.set("price", price);
		    carObject.set("isSold", false);
		    if (document.getElementById("inputMileage").value) {
		    	carObject.set("mileage", mileage);
		    }
		    if (document.getElementById("inputPreviousOwners").value) {
		    	carObject.set("previousOwners", previousOwners);
		    }
		    if (document.getElementById("inputEngine").value) {
		    	carObject.set("engine", engine + "cc");
		    }
		    if (transmission) {
		    	carObject.set("transmission", transmission);
		    }
		    if (fuelType) {
		    	carObject.set("fuelType", fuelType);
		    }
		    if (color) {
		    	carObject.set("color", color);
		    }
		    if (location) {
		    	carObject.set("location", location);
		    }

		    var fileUploadControl = $("#coverImg")[0];
		    var file = fileUploadControl.files[0];
		    var name = "coverImage.png";

		    var parseFile = new Parse.File(name, file);


		    parseFile.save();
		    carObject.set("coverImage", parseFile);		
		    

			fileUploadControl = $("#galleryImgs")[0];
			var relation = carObject.relation("galleryImage")
			for (var i = 0; i < fileUploadControl.files.length; i++) {
				var GalleryImage = Parse.Object.extend("GalleryImages");
		    	var galleryImage = new GalleryImage();

		    	var file = fileUploadControl.files[0];
			    var name = "galleryImage" + (i+1) + ".png";

			    parseFile = new Parse.File(name, file);
			    parseFile.save();

			    galleryImage.set("image", parseFile);
			    galleryImage.save(null, {
				  success: function(gameScore) {
			    	relation.add(galleryImage);
				  },
				  error: function(gameScore, error) {
				  }
				});
			}

			sendPush();

			carObject.save(null, {
			  success: function(gameScore) {
			    alert('Successfully uploaded');
			    window.location.replace('manage.html');
			  },
			  error: function(gameScore, error) {
			    alert('Failed to upload the car, cause: ' + error.message);
			  }
			});

		}
	</script>
  </body>
</html>