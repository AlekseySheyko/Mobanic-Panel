<!DOCTYPE html>
<html lang="en">
  <head>
  	<meta charset="utf-8">

	<title>Mobanic - Upload</title>
	<link rel="icon" type="image/png" href="img/favicon.png">	
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link href="css/jumbotron-narrow.css" rel="stylesheet">
  	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.4.2.min.js"></script>
  	<script type="text/javascript">
	    Parse.initialize("asQfJUeEXdJnbfvG2iefkvjhVpcmIq2GnOp5x5P2", "nekbtqyfm8m3K6DRekriIij1U3fnxPLGiAq01Nf7");

	    var currentUser = Parse.User.current();
		if (!currentUser) {
		    window.location.replace('manage.html');
		}
  	</script>
  </head>

  <body>
  	<div class="container">

  		<div class="header clearfix">
	        <nav>
	          <ul class="nav nav-pills pull-right">
	            <li role="presentation" class="active"><a href="index.html">Portal</a></li>
	            <li role="presentation"><a href="http://mobanic.com">Home</a></li>	            
	            <a href="#" onclick="logout();return false;" class="pull-right" style="margin-left: 8px; margin-right: 0px; margin-top: 10px; color: #555;">Log out</a>
	          </ul>
	        </nav>
	        <a href="manage.html"><img src="img/header_logo.png"</img></a>
    	</div>

	    <div class="jumbotron">

	    	<form id="foo" onsubmit="return saveCar(event);" enctype="multipart/form-data">
				<div class="row">
				  <div class="col-md-9"><h1 style="font-size: 40px">Upload new car</h1></div>
				  </div>
				<br><br>
				<div class="form-group col-xs-3">
				  <input type="text" class="input-lg" id="inputMake" style="margin-left: -15px; text-transform: uppercase" placeholder="Registration mark" required autofocus>
				</div>
				<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
				<button type="submit" class="btn btn-lg btn-success">Save</button>
		  </form>

		</div>

		<br><br>

		<footer class="footer">
	      <p class="text-center">Copyright Â© 2015 Mobanic Ltd</p>
	    </footer>
    </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
	<script src="autoNumeric.js"></script>
	<script type="text/javascript">
		function logout() {
			Parse.User.logOut();
		    window.location.replace('index.html');
		}

		$( document ).ready( function() {
	      $("#inputPrice").autoNumeric(
	        'init', {aSep: ',', mDec: '0', vMax: '999999999'}
	      );
	      $("#inputMileage").autoNumeric(
	        'init', {aSep: ',', mDec: '0', vMax: '9999999'}
	      );
	    });

		var counter = 1;
		var limit = 10;
		function addInput(divName){

		     if (counter == limit)  {
		          alert("You have reached the limit of adding " + counter + " features");
		     }
		     else {
		          var newdiv = document.createElement('div');
		          newdiv.innerHTML = "<input type='text' class='form-control'  style='border-radius: 0' " + 
		          					 			"name='bar[]' placeholder='Feature #" + (counter + 1) + "'>";
		          document.getElementById(divName).appendChild(newdiv);
		          counter++;
		     }
		}

		function sendPush() {
			Parse.Push.send({
						  where: new Parse.Query(Parse.Installation),
						  data: {
				          	alert: "Update car listing"
				          }
						});
		}

	 	function saveCar(event) {
			event.preventDefault();

			var make = document.getElementById("inputMake").value;
			var model = document.getElementById("inputModel").value;
			var year = parseInt(document.getElementById("inputYear").value);
			var price = parseInt(document.getElementById("inputPrice").value.replace(/,/g, ''));
			var mileage = parseInt(document.getElementById("inputMileage").value.replace(/,/g, ''));
			var previousOwners = parseInt(document.getElementById("inputPreviousOwners").value);
			var engine = parseInt(document.getElementById("inputEngine").value);
			var transmission = document.getElementById("inputTransmission").value;
			var fuelType = document.getElementById("inputFuelType").value;
			var color = document.getElementById("inputColor").value;
			var location = document.getElementById("inputLocation").value;

			var CarObject = Parse.Object.extend("Car");
		    var carObject = new CarObject();

		    carObject.set("make", make);
		    carObject.set("model", model);
		    carObject.set("year", year);
		    carObject.set("price", price);
		    carObject.set("isSold", false);
		    if (document.getElementById("inputMileage").value) {
		    	carObject.set("mileage", mileage);
		    }
		    if (document.getElementById("inputPreviousOwners").value) {
		    	carObject.set("previousOwners", previousOwners);
		    }
		    if (document.getElementById("inputEngine").value) {
		    	carObject.set("engine", engine + "cc");
		    }
		    if (transmission) {
		    	carObject.set("transmission", transmission);
		    }
		    if (fuelType) {
		    	carObject.set("fuelType", fuelType);
		    }
		    if (color) {
		    	carObject.set("color", color);
		    }
		    if (location) {
		    	carObject.set("location", location);
		    }

			var inputs = document.querySelectorAll("#foo input[name='bar[]']");
			for (var i = 0; i < inputs.length; i++) {
			   	if (inputs[i].value != "") {
			   		carObject.addUnique("features", inputs[i].value);
			   	}
			}

		    var fileUploadControl = $("#coverImg")[0];
		    var file = fileUploadControl.files[0];
		    var name = "coverImage.png";

		    var parseFile = new Parse.File(name, file);


		    parseFile.save();
		    carObject.set("coverImage", parseFile);		
		    

			var relation = carObject.relation("galleryImage");

			fileUploadControl = $("#galleryImgs")[0];
			if (fileUploadControl.files.length > 5) {
				alert("You can upload a maximum of 5 images");
				return;
			}


			var GalleryImage;
			var galleryImage;

				
				GalleryImage = Parse.Object.extend("GalleryImages");
			    galleryImage = new GalleryImage();

			    file = fileUploadControl.files[0];
			    if (file == null) {
				    carObject.save(null, {
					  success: function(carObject) {
						sendPush();	
					    window.location.replace('manage.html');
					  },
					  error: function(carObject, error) {
					    alert('Failed to upload the car, cause: ' + error.message);
					  }
					});
			    	return;
			    }
				name = "galleryImage1.png";

				parseFile = new Parse.File(name, file);
				parseFile.save().then(function() {
				  // The file has been saved to Parse.
				  galleryImage.set("image", parseFile);
				  galleryImage.save(null, {
				  	  success: function(galleryImage) {
						    relation.add(galleryImage);


						    GalleryImage = Parse.Object.extend("GalleryImages");
						    galleryImage = new GalleryImage();

						    file = fileUploadControl.files[1];
						    if (file == null) {
							    carObject.save(null, {
								  success: function(carObject) {
									sendPush();
								    alert('Successfully uploaded');
								    window.location.replace('manage.html');
								  },
								  error: function(carObject, error) {
								    alert('Failed to upload the car, cause: ' + error.message);
								  }
								});
						    	return;
						    }
							name = "galleryImage2.png";

							parseFile = new Parse.File(name, file);
							parseFile.save().then(function() {
							  // The file has been saved to Parse.
							  galleryImage.set("image", parseFile);
							  galleryImage.save(null, {
							  	  success: function(galleryImage) {
									    relation.add(galleryImage);



									    GalleryImage = Parse.Object.extend("GalleryImages");
									    galleryImage = new GalleryImage();

									    file = fileUploadControl.files[2];
									    if (file == null) {
										    carObject.save(null, {
											  success: function(carObject) {
												sendPush();
											    alert('Successfully uploaded');
											    window.location.replace('manage.html');
											  },
											  error: function(carObject, error) {
											    alert('Failed to upload the car, cause: ' + error.message);
											  }
											});
									    	return;
									    }
										name = "galleryImage3.png";

										parseFile = new Parse.File(name, file);
										parseFile.save().then(function() {
										  // The file has been saved to Parse.
										  galleryImage.set("image", parseFile);
										  galleryImage.save(null, {
										  	  success: function(galleryImage) {
												    relation.add(galleryImage);



												    GalleryImage = Parse.Object.extend("GalleryImages");
												    galleryImage = new GalleryImage();

												    file = fileUploadControl.files[3];
												    if (file == null) {
													    carObject.save(null, {
														  success: function(carObject) {
															sendPush();
														    alert('Successfully uploaded');
														    window.location.replace('manage.html');
														  },
														  error: function(carObject, error) {
														    alert('Failed to upload the car, cause: ' + error.message);
														  }
														});
												    	return;
												    }
													name = "galleryImage4.png";

													parseFile = new Parse.File(name, file);
													parseFile.save().then(function() {
													  // The file has been saved to Parse.
													  galleryImage.set("image", parseFile);
													  galleryImage.save(null, {
													  	  success: function(galleryImage) {
															    relation.add(galleryImage);



															    GalleryImage = Parse.Object.extend("GalleryImages");
															    galleryImage = new GalleryImage();

															    file = fileUploadControl.files[4];
															    if (file == null) {
																    carObject.save(null, {
																	  success: function(carObject) {
																		sendPush();
																	    alert('Successfully uploaded');
																	    window.location.replace('manage.html');
																	  },
																	  error: function(carObject, error) {
																	    alert('Failed to upload the car, cause: ' + error.message);
																	  }
																	});
															    	return;
															    }
																name = "galleryImage5.png";

																parseFile = new Parse.File(name, file);
																parseFile.save().then(function() {
																  // The file has been saved to Parse.
																  galleryImage.set("image", parseFile);
																  galleryImage.save(null, {
																  	  success: function(galleryImage) {
																		    relation.add(galleryImage);



																		    GalleryImage = Parse.Object.extend("GalleryImages");
																		    galleryImage = new GalleryImage();

																		    file = fileUploadControl.files[5];
																		    if (file == null) {
																			    carObject.save(null, {
																				  success: function(carObject) {
																					sendPush();
																				    alert('Successfully uploaded');
																				    window.location.replace('manage.html');
																				  },
																				  error: function(carObject, error) {
																				    alert('Failed to upload the car, cause: ' + error.message);
																				  }
																				});
																		    	return;
																		    }
																			name = "galleryImage6.png";

																			parseFile = new Parse.File(name, file);
																			parseFile.save().then(function() {
																			  // The file has been saved to Parse.
																			  galleryImage.set("image", parseFile);
																			  galleryImage.save(null, {
																			  	  success: function(galleryImage) {
																					    relation.add(galleryImage);


																				carObject.save(null, {
																				  success: function(carObject) {
																					sendPush();
																				    alert('Successfully uploaded');
																				    window.location.replace('manage.html');
																				  },
																				  error: function(carObject, error) {
																				    alert('Failed to upload the car, cause: ' + error.message);
																				  }
																				});
																		    	return;





																					}
																				  });
																				}, function(error) {
																				  // The file either could not be read, or could not be saved to Parse.
																				});



																		}
																	  });
																	}, function(error) {
																	  // The file either could not be read, or could not be saved to Parse.
																	});



															}
														  });
														}, function(error) {
														  // The file either could not be read, or could not be saved to Parse.
														});


													}
												  });
												}, function(error) {
												  // The file either could not be read, or could not be saved to Parse.
												});


										}
									  });
									}, function(error) {
									  // The file either could not be read, or could not be saved to Parse.
									});
						    
					  }
				  });
				}, function(error) {
				  // The file either could not be read, or could not be saved to Parse.
				});

		}
	</script>
  </body>
</html>